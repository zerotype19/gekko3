<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gekko3 Command Center</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --green: #22c55e; --red: #ef4444; --blue: #3b82f6; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.5rem; }
        .status-badge { padding: 4px 12px; border-radius: 99px; font-weight: bold; font-size: 0.875rem; }
        .status-normal { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .status-locked { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .metric { display: flex; flex-direction: column; }
        .label { font-size: 0.75rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.05em; }
        .value { font-size: 1.5rem; font-weight: bold; }
        .controls { display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-lock { background: var(--red); color: white; }
        .btn-unlock { background: var(--green); color: white; }
        .btn-lock:hover, .btn-unlock:hover { opacity: 0.9; }
        .hidden { display: none; }
        .lock-reason { margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; font-size: 0.875rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>Gekko3 Command Center</h1>
                <span id="systemStatus" class="status-badge status-normal">LOADING...</span>
            </div>
            <div id="lockReason" class="lock-reason hidden"></div>
            <div class="grid">
                <div class="metric">
                    <span class="label">Positions</span>
                    <span id="posCount" class="value">--</span>
                </div>
                <div class="metric">
                    <span class="label">Daily PnL</span>
                    <span id="pnl" class="value">--</span>
                </div>
                <div class="metric">
                    <span class="label">Heartbeat</span>
                    <span id="heartbeat" class="value">--</span>
                </div>
                <div class="metric">
                    <span class="label">Equity</span>
                    <span id="equity" class="value">--</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top: 0;">Emergency Controls</h3>
            <div class="controls">
                <button id="btnLock" class="btn-lock" onclick="toggleLock(true)">ðŸ”’ LOCK SYSTEM</button>
                <button id="btnUnlock" class="btn-unlock hidden" onclick="toggleLock(false)">ðŸ”“ UNLOCK SYSTEM</button>
            </div>
            <p style="font-size: 0.8rem; opacity: 0.6; margin-top: 10px;">Locking prevents all new trades immediately.</p>
        </div>
    </div>

    <script>
        const API_BASE = '/v1';
        
        async function updateStatus() {
            try {
                const res = await fetch(`${API_BASE}/status`);
                const data = await res.json();
                
                // Update System Status
                const statusBadge = document.getElementById('systemStatus');
                const btnLock = document.getElementById('btnLock');
                const btnUnlock = document.getElementById('btnUnlock');
                const lockReasonEl = document.getElementById('lockReason');
                
                if (data.status === 'LOCKED') {
                    statusBadge.textContent = 'SYSTEM LOCKED';
                    statusBadge.className = 'status-badge status-locked';
                    btnLock.classList.add('hidden');
                    btnUnlock.classList.remove('hidden');
                    if (data.lockReason) {
                        lockReasonEl.textContent = `Lock Reason: ${data.lockReason}`;
                        lockReasonEl.classList.remove('hidden');
                    } else {
                        lockReasonEl.classList.add('hidden');
                    }
                } else {
                    statusBadge.textContent = 'OPERATIONAL';
                    statusBadge.className = 'status-badge status-normal';
                    btnLock.classList.remove('hidden');
                    btnUnlock.classList.add('hidden');
                    lockReasonEl.classList.add('hidden');
                }

                // Update Metrics
                document.getElementById('posCount').textContent = data.positionsCount || 0;
                const pnlPercent = ((data.dailyPnL || 0) * 100).toFixed(2);
                document.getElementById('pnl').textContent = (data.dailyPnL >= 0 ? '+' : '') + pnlPercent + '%';
                document.getElementById('pnl').style.color = data.dailyPnL >= 0 ? 'var(--green)' : 'var(--red)';
                document.getElementById('equity').textContent = '$' + (data.equity || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

                // Heartbeat Logic
                const lastHeartbeat = data.lastHeartbeat || 0;
                const secondsAgo = lastHeartbeat > 0 ? Math.floor((Date.now() - lastHeartbeat) / 1000) : 999999;
                const hbEl = document.getElementById('heartbeat');
                
                if (lastHeartbeat === 0) {
                    hbEl.textContent = '--';
                    hbEl.style.color = 'var(--text)';
                } else if (secondsAgo < 60) {
                    hbEl.textContent = 'ðŸŸ¢ Online';
                    hbEl.style.color = 'var(--green)';
                } else if (secondsAgo < 300) {
                    hbEl.textContent = `âš ï¸ ${secondsAgo}s Ago`;
                    hbEl.style.color = 'orange';
                } else {
                    hbEl.textContent = 'ðŸ”´ Offline';
                    hbEl.style.color = 'var(--red)';
                }

            } catch (e) {
                console.error('Status update error:', e);
                document.getElementById('systemStatus').textContent = 'ERROR';
                document.getElementById('systemStatus').className = 'status-badge status-locked';
            }
        }

        async function toggleLock(lock) {
            const endpoint = lock ? 'admin/lock' : 'admin/unlock';
            const reason = lock ? prompt("Enter reason for locking (optional):", "Manual Override") : null;
            
            try {
                const res = await fetch(`${API_BASE}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reason ? { reason } : {})
                });
                if (!res.ok) {
                    alert('Failed to ' + (lock ? 'lock' : 'unlock') + ' system');
                }
                updateStatus();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        setInterval(updateStatus, 2000);
        updateStatus();
    </script>
</body>
</html>
